<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Message Area - Enhanced Version</title>
    <meta name="description" content="Private messaging with enhanced features">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #e8e8e8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 4s infinite;
        }
        
        .star.small { width: 1px; height: 1px; opacity: 0.6; }
        .star.medium { width: 2px; height: 2px; opacity: 0.4; }
        .star.large { width: 3px; height: 3px; opacity: 0.3; }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .connection-status.online {
            border: 1px solid rgba(46, 213, 115, 0.5);
            color: #2ed573;
        }
        
        .connection-status.offline {
            border: 1px solid rgba(255, 71, 87, 0.5);
            color: #ff4757;
        }
        
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #2ed573;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .header {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        /* NEW: Back Button Styles */
        .back-button {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #FF7043, #FF8A65);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 1001;  /* ADD THIS LINE */
}
        
        .back-button:hover {
            transform: translateY(-50%) translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 112, 67, 0.4);
            background: linear-gradient(135deg, #FF8A65, #FFAB91);
        }
        
        .back-button::before {
            content: '‚Üê ';
            margin-right: 5px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }
        
        .container {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .messages-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }
        
        .message-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 34px;
            height: 18px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #4CAF50;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(16px);
        }
        
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.derek {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(129, 199, 132, 0.2));
            border: 1px solid rgba(76, 175, 80, 0.3);
            align-self: flex-end;
        }
        
        .message.nancy {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(100, 181, 246, 0.2));
            border: 1px solid rgba(33, 150, 243, 0.3);
            align-self: flex-start;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .message-author {
            font-weight: bold;
            color: #ffd93d;
        }
        
        .message-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }
        
        .message-content {
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            word-wrap: break-word;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            text-align: center;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-messages {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            padding: 40px 20px;
        }
        
        .input-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .input-header {
            text-align: center;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .message-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            resize: vertical;
            font-family: inherit;
        }
        
        .message-textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }
        
        .message-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .char-counter {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
            margin-top: -10px;
        }
        
        .char-counter.warning { color: #ff9500; }
        .char-counter.danger { color: #ff4757; }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-button {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }
        
        .action-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }
        
        .action-button:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: none;
        }
        
        .action-button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: buttonSpin 1s linear infinite;
            transform: translate(-50%, -50%);
        }
        
        .action-button.loading { color: transparent; }
        
        @keyframes buttonSpin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .refresh-button {
            background: linear-gradient(135deg, #2196F3, #64B5F6);
        }
        
        .refresh-button:hover:not(:disabled) {
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }
        
        .photo-album-button {
            background: linear-gradient(135deg, #9C27B0, #E1BEE7);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: none;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
            margin-top: 15px;
        }

        .photo-album-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(156, 39, 176, 0.4);
        }

        .photo-album-button::before {
            content: '12757982';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 300;
            color: rgba(255, 255, 255, 0.15);
            z-index: 1;
            pointer-events: none;
        }

        .photo-album-button .button-text {
            position: relative;
            z-index: 2;
        }
        
        .status-message {
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .status-message.show { opacity: 1; }
        
        .status-message.success {
            background: rgba(76, 175, 80, 0.2);
            color: #A5D6A7;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }
        
        .status-message.error {
            background: rgba(244, 67, 54, 0.2);
            color: #EF9A9A;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }
        
        .status-message.info {
            background: rgba(33, 150, 243, 0.2);
            color: #81D4FA;
            border: 1px solid rgba(33, 150, 243, 0.5);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .message { max-width: 90%; padding: 12px 15px; }
            .form-actions { flex-direction: column; gap: 10px; }
            .action-button { width: 100%; }
            .message-stats { flex-direction: column; gap: 8px; align-items: flex-start; }
            .connection-status { top: 10px; right: 10px; font-size: 0.7rem; padding: 6px 10px; }
            
            /* NEW: Mobile back button adjustment */
            .back-button {
                position: static;
                transform: none;
                margin-bottom: 15px;
                display: block;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
            
            .back-button:hover {
                transform: translateY(-2px);
            }
            
            .header {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="starfield" id="starfield"></div>
    
    <div class="connection-status" id="connectionStatus">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">Connecting...</span>
    </div>
    
    <header class="header">
        <a href="rebecca-private-message.html" class="back-button">Back</a>
        <h1>Private Messages</h1>
        <p>Nancy & Derek's secure messaging system</p>
    </header>
    
    <main class="container">
        <div class="messages-container" id="messagesContainer">
            <div class="message-stats" id="messageStats">
                <span id="messageCount">Loading...</span>
                <div class="auto-refresh-toggle">
                    <label>Auto-refresh</label>
                    <div class="toggle-switch active" id="autoRefreshToggle" onclick="toggleAutoRefresh()"></div>
                </div>
                <span id="lastUpdated">Last updated: --:--</span>
            </div>
            
            <div class="loading-container" id="loadingContainer">
                <div class="loading-spinner"></div>
                <div>Loading messages...</div>
            </div>
            
            <div class="messages-list" id="messagesList" style="display: none;"></div>
            
            <div class="no-messages" id="noMessages" style="display: none;">
                <h3>üì¨ No messages yet</h3>
                <p>Send the first message below!</p>
            </div>
        </div>
        
        <div class="input-container">
            <div class="input-header">
                Send a Private Message
                <div class="status-indicator" id="headerStatusIndicator"></div>
            </div>
            
            <form class="message-form" id="messageForm">
                <textarea 
                    id="messageText" 
                    class="message-textarea" 
                    placeholder="Type your message here..."
                    maxlength="1000"
                    required
                ></textarea>
                
                <div class="char-counter" id="charCounter">0 / 1000</div>
                
                <div class="form-actions">
                    <button type="submit" class="action-button" id="submitButton">
                        Send Message
                    </button>
                    <button type="button" class="action-button refresh-button" id="refreshButton">
                        Refresh Messages
                    </button>
                </div>
                
                <div style="text-align: center;">
                    <a href="private-photo-album.html" class="photo-album-button">
                        <span class="button-text">A Special Photo Album Just for Nancy :)</span>
                    </a>
                </div>
                
                <div class="status-message" id="statusMessage"></div>
            </form>
        </div>
    </main>
    
    <script>
        <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Message Across Time - A Letter Guide For Rebecca</title>
    <meta name="description" content="A private message 35 years in the making">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #e8e8e8;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }
        
        /* Animated Background */
        .particle-field {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.4; }
            90% { opacity: 0.4; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 50px 20px 40px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .main-title {
            font-size: clamp(2.5rem, 5vw, 4rem);
            background: linear-gradient(120deg, #ffd89b, #19547b, #ffd89b);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 10s ease-in-out infinite;
            margin-bottom: 15px;
            font-weight: 300;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: clamp(1rem, 2vw, 1.3rem);
            color: rgba(255, 255, 255, 0.75);
            font-style: italic;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Music prompt box */
        .music-prompt-container {
            max-width: 1000px;
            margin: 40px auto 20px;
            padding: 0 20px;
        }
        
        .music-prompt-box {
            background: linear-gradient(135deg, rgba(255, 217, 155, 0.15), rgba(168, 216, 234, 0.15));
            border: 2px solid rgba(255, 217, 155, 0.4);
            border-radius: 15px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
        }
        
        .music-prompt-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 217, 155, 0.3);
            border-color: rgba(255, 217, 155, 0.6);
            background: linear-gradient(135deg, rgba(255, 217, 155, 0.2), rgba(168, 216, 234, 0.2));
        }
        
        .music-prompt-box p {
            font-size: clamp(1rem, 2vw, 1.2rem);
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
            line-height: 1.6;
            font-style: italic;
            letter-spacing: 0.5px;
        }
        
        .music-prompt-box .music-note {
            font-size: 1.5rem;
            color: #ffd89b;
            margin-top: 10px;
            animation: musicNote 2s ease-in-out infinite;
        }
        
        .music-prompt-container.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            transition: all 0.5s ease;
        }
        
        /* Letter Container */
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 60px 20px;
            position: relative;
        }
        
        .letter-wrapper {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            border-radius: 30px;
            padding: 50px;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 30px 90px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        /* Elegant corner decorations */
        .letter-wrapper::before,
        .letter-wrapper::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            border: 2px solid rgba(255, 215, 155, 0.3);
        }
        
        .letter-wrapper::before {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }
        
        .letter-wrapper::after {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }
        
        /* Letter Content */
        .letter-content {
            position: relative;
            z-index: 2;
        }
        
        .letter-greeting {
            font-size: clamp(1.3rem, 2.5vw, 1.6rem);
            color: #ffd89b;
            margin-bottom: 35px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-align: left;
        }
        
        .letter-body p {
            font-size: clamp(1.05rem, 2vw, 1.18rem);
            line-height: 1.9;
            color: rgba(255, 255, 255, 0.92);
            margin-bottom: 28px;
            text-align: justify;
            hyphens: auto;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .letter-body p:first-of-type::first-letter {
            font-size: 3.5em;
            line-height: 0.8;
            float: left;
            margin: 10px 12px 0 0;
            color: #ffd89b;
            font-weight: 500;
        }
        
        /* Indented paragraphs for classic letter feel */
        .letter-body p {
            text-indent: 2em;
        }
        
        .letter-body p:first-of-type {
            text-indent: 0;
        }
        
        /* Special emphasis styles */
        .emotional-text {
            color: #a8d8ea;
            font-style: italic;
            position: relative;
            padding: 0 4px;
        }
        
        .highlight-text {
            color: #ffd89b;
            font-weight: 500;
            position: relative;
        }
        
        .gentle-emphasis {
            color: #ffb8b8;
            font-weight: 400;
        }
        
        /* Letter signature */
        .letter-signature {
            margin-top: 50px;
            text-align: right;
            font-size: clamp(1.1rem, 2vw, 1.3rem);
            color: rgba(255, 255, 255, 0.85);
            font-style: italic;
        }
        
        .letter-signature .name {
            font-size: clamp(1.3rem, 2.5vw, 1.6rem);
            color: #ffd89b;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .letter-signature .code {
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }
        
        /* Button Section */
        .button-section {
            text-align: center;
            margin-top: 60px;
            padding: 40px 20px;
        }
        
        .button-intro {
            font-size: clamp(1.1rem, 2.5vw, 1.4rem);
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 35px;
            font-style: italic;
            letter-spacing: 0.5px;
        }
        
        .butt-button {
            display: inline-block;
            background: linear-gradient(135deg, rgba(255, 184, 184, 0.3), rgba(255, 217, 155, 0.3)), url('./images/perfection.jpg') !important;
            background-size: cover, cover !important;
            background-position: center, center !important;
            background-blend-mode: overlay !important;
            border: 2px solid rgba(255, 215, 155, 0.5) !important;
            border-radius: 50px;
            padding: 108px 90px !important;
            min-width: 500px !important;
            min-height: 324px !important;
            font-size: clamp(1.2rem, 3vw, 1.6rem);
            font-weight: 600;
            color: white !important;
            text-decoration: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 45px rgba(255, 215, 155, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.7) !important;
        }
        
        .butt-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.7s;
        }
        
        .butt-button:hover::before {
            left: 100%;
        }
        
        .butt-button:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(255, 215, 155, 0.5);
            border-color: rgba(255, 215, 155, 0.7) !important;
        }
        
        .escape-button {
            display: inline-block;
            background: linear-gradient(135deg, #c94b4b, #4b134f) !important;
            border: 2px solid rgba(201, 75, 75, 0.6) !important;
            border-radius: 50px;
            padding: 108px 90px !important;
            min-width: 500px !important;
            min-height: 324px !important;
            font-size: clamp(1.1rem, 2.8vw, 1.4rem);
            font-weight: 600;
            color: white !important;
            text-decoration: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 45px rgba(201, 75, 75, 0.3);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.7) !important;
            margin-top: 30px;
        }
        
        .escape-button:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(201, 75, 75, 0.5);
        }
        
        .button-joke {
            margin: 25px 0;
            font-size: clamp(0.95rem, 2vw, 1.15rem);
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }
        
        /* Floating hearts */
        .floating-heart {
            position: fixed;
            color: #ffb8b8;
            font-size: 22px;
            animation: floatHeart 15s infinite linear;
            pointer-events: none;
            z-index: 1;
            opacity: 0.7;
        }
        
        @keyframes floatHeart {
            0% {
                transform: translateY(100vh) rotate(0deg) scale(0.8);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) rotate(360deg) scale(1.2);
                opacity: 0;
            }
        }
        
        /* Music indicator */
        .music-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .music-indicator.show {
            opacity: 1;
        }
        
        .music-indicator .note {
            display: inline-block;
            animation: musicNote 2s ease-in-out infinite;
        }
        
        @keyframes musicNote {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .letter-wrapper {
                padding: 35px 25px;
                border-radius: 20px;
            }
            
            .letter-wrapper::before,
            .letter-wrapper::after {
                width: 60px;
                height: 60px;
            }
            
            .letter-body p {
                text-indent: 1.5em;
                margin-bottom: 24px;
            }
            
            .butt-button, .escape-button {
                padding: 70px 60px !important;
                min-width: 350px !important;
                min-height: 210px !important;
            }
            
            .music-indicator {
                bottom: 10px;
                right: 10px;
                font-size: 0.7rem;
                padding: 6px 10px;
            }
        }
        
        @media (max-width: 480px) {
            .letter-wrapper {
                padding: 25px 20px;
            }
            
            .letter-wrapper::before,
            .letter-wrapper::after {
                display: none;
            }
            
            .letter-body p:first-of-type::first-letter {
                font-size: 2.5em;
                margin: 5px 8px 0 0;
            }
            
            .butt-button, .escape-button {
                padding: 50px 40px !important;
                min-width: 280px !important;
                min-height: 160px !important;
            }
        }
        
        /* Fade-in animations */
        .fade-in {
            opacity: 0;
            animation: fadeIn 1.5s ease-out forwards;
        }
        
        .fade-in-delay {
            opacity: 0;
            animation: fadeIn 1.5s ease-out 0.6s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="particle-field" id="particleField"></div>
    
    <!-- Music indicator -->
    <div class="music-indicator" id="musicIndicator">
        <span class="note">‚ô™</span> Background music playing
    </div>
    
    <header class="header fade-in">
        <h1 class="main-title">You Made It, Nancy!</h1>
        <p class="subtitle">A Message 37 Years in the Making</p>
    </header>
    
    <!-- Music prompt box -->
    <div class="music-prompt-container fade-in-delay" id="musicPromptContainer">
        <div class="music-prompt-box" onclick="startMusicFromPrompt()">
            <p>I selected a very special song for some background music while you read the letter, click here to start the music</p>
            <div class="music-note">‚ô™</div>
        </div>
    </div>
    
    <main class="content-container">
        <div class="letter-wrapper fade-in-delay">
            <div class="letter-content">
                <div class="letter-greeting">Dear Nancy,</div>
                
                <div class="letter-body">
                    <p>If you're here reading this, then I lost a bet to Greg. I told him I highly doubted you would ever bother to visit the website‚Äîeven if you found out I wrote a book that contained some stories from the time we had dated. I tried to explain to him that "you were not wired that way" (yes, one of my favorite expressions, if you ever did read any of my writings).</p>
                    
                    <p>When we were a couple, you were always the optimist and forward thinker, while I was Mr. Analysis. I am even worse at that than when you knew me. But just on the off chance I was wrong and you are actually reading this, then I will try to keep it on topic, so to speak.</p>
                    
                    <p>I suspect that you have always either known or suspected‚Äîat a few points in your life, mostly a long time ago, or around the time I sent you that text‚Äîthat I had never gotten over you. If you didn't, well... maybe you should read the book <span class="gentle-emphasis">"A Letter Guide For Rebecca,"</span> because it would support my position that I have never gotten over you. In fact, it would most likely support a much worse condition than that.</p>
                    
                    <p><span class="emotional-text">You see, that infamous day you drove to my place in the Gremlin and proceeded to tell me you wanted to break up because you wanted to go to University single... Yes, that day... Well, something I would like you to know is it was not just a simple high school girlfriend and boyfriend break-up for me. It was emotionally devastating.</span> What I did not disclose to you when I returned from Miami was that, for me, I had come to the personal and emotional view that I wanted to spend the rest of my life with you. Yup, I had fallen all the way! Not only was I madly in love with you, I wanted to marry you in the near future. The problem, though‚ÄîI knew I couldn't tell you then, out of fear it may send you packing (scare you on some level). Truth be told, I know you said before I left for school, "I think I am falling in love with you." I was waiting for a new sign that that was true... Thus my dilemma.</p>
                    
                    <p>Now, before I get any further with this past truth, I want you to know that what I am about to tell you‚Äîyou did nothing wrong. You were a young woman (girl) who had a high school boyfriend and was trying to figure out what you wanted to do with your life. <span class="highlight-text">You never misled me or would want to intentionally hurt me; that, I know in my heart.</span> But as you had come to a different point in your life regarding me, I was all in on you. And that day you broke up with me broke me. I was devastated beyond words. I was also not capable of accepting or dealing with the emotional trauma. That was something I never understood back then. I was a very smart and capable person, and because I lacked the ability to deal with the emotional trauma, my brain kicked in and did what it was good at‚Äîit decided to counter the enormous pain I was experiencing. My solution was simply to figure out how to win you back.</p>
                    
                    <p>I know you knew on some level how I felt, even after the break-up. If our trip to London to your new house just before your first year at Western didn't tip you off, there were many other signs. It eventually consumed not only all my mental processing but also all my own personal ambition and desires. Believe me, looking back, I so wished I could have simply licked my emotional wounds and moved on. Maybe I would be married to Maureen Hanmer today (a joke, if you didn't read any of my writings).</p>
                    
                    <p>There were a few other moments involving you that added to my emotional instability over the dumping that I know you have no idea of. The first‚Äîand I would say the moment that pushed me over the edge of my own sanity‚Äîwas running into you and Jeff Teal at your house. Not sure if you even remember that encounter. I had just stopped by to say hello to your folks (still trying to keep one foot in the door...), and as I was leaving, you guys drove into your driveway.</p>
                    
                    <p><span class="emotional-text">Seeing you with him was more than I could take.</span> I learned how to put on a good face, and that time, I think, was worthy of at least an Oscar nod. For the next couple of weeks, I found myself spiraling into the deepest depression I have‚Äîand had‚Äîever experienced. I hid it from everyone. Greg was away at school, so I couldn't talk to him. And you would have been the only other person I could have opened up to. At the lowest point, I started planning my own suicide‚Äîand you know it was not just going to be a quiet and simple one with me. No... I was going to make it a spectacular offing. I was going to hang myself at the Hermitage, along with a love note that I was hoping would devastate you, hurt you, believing you needed to experience, if only for a moment, what I was experiencing consantly at that time.</p>
                    
                    <p>But what I didn't expect to discover about myself was twofold. First, I was concerned that people may try to call me a coward for taking the easy way out of the pain I was in. And then the other thing that saved me was also going to be somewhat of a curse... <span class="highlight-text">I could never hurt you. Especially that way.</span> So, I finally made a decision that I needed to get out of Dodge! I needed to get far away and try to figure it out in a way that didn't include me killing myself. So that became my new plan. Unfortunately for me, I was also broke and didn't have the money to flee to emotional safety. And now we come full circle to my other curse... I was a very smart and capable guy!</p>
                    
                    <p>Okay, maybe not as smart as I thought... And that, my former love of my life (from my perspective), is something I have always wanted to confess to you but never got the opportunity till now. Only two people know about this now‚Äîme and you. Greg doesn't even know.</p>
                    
                    <p>After my release and eventual return to Toronto and my job at Matrix Financial, there was one more major event that had a tremendous impact on me. It was the day you called me at my office and tried to pitch me on some new share offering your company was promoting. Yup, I was now simply a stock potential chump customer! I guess you could actually view this as the moment I came to grips that I was not the one. I handled it much better than the other major emotional blow you delivered and ended up spending a lot of time at the gym lifting weights! But even that was not free from an eventual negative side effect. Turns out I compressed my lower spine a lot, and today I enjoy some good old-fashioned arthritis pain...</p>
                    
                    <p>After that call, you would not have noticed (you're not wired that way), but I never did contact you again. For me, I was relegated to trying to find the second-best girl in the world for me... And that, my wonderfully gifted backside, love of my life, is a story that may have to find itself into a future book. Although, a lot of my life is woven into <span class="gentle-emphasis">"A Letter Guide For Rebecca."</span> It was my first attempt at writing, and at the time I decided to write the book, it was more about being able to tell (document) my story on some level than trying to be some great writer. That being said, what I did come to realize: <span class="highlight-text">I actually enjoyed the writing process a great deal, and I think my writing is constantly improving.</span> I wrote a TV series called <span class="gentle-emphasis">"Living With the Ghost of Sam,"</span> which I eventually converted into a 10-book novella series. In my latest effort (as of 2025), I wrote a science fiction/love story series called <span class="gentle-emphasis">"The Last Axiom."</span> It is a 16-book series.</p>
                    
                    <p>Who knew I was so creatively inclined? I also expressed my old musical desires and wrote a song for Michael Smerconish's POTUS Radio show called <span class="gentle-emphasis">"The Mingle Effect."</span> They use it on the show when he talks about his "Mingle Project" crusade. And there was no way I would write a book called <span class="gentle-emphasis">"A Letter Guide For Nancy"</span> without writing the future theme song for the eventual movie they will make (you better be smiling at this). The original version was called "Nancy's Song," but I changed it when I decided to protect your privacy and changed it to "Rebecca's Song" (aka Nancy's Song). Both songs are on the respective websites of the same name and available on Spotify or YouTube. So, if you ever decide to claim the title as being Rebecca 1.0, you can tell your kids that someone wrote a song about you! That Aka Nancy is actually you.</p>
                    
                    <p>That's it, Nancy. I know you reached your limit, and I will once again prognosticate that you will quickly digest this and move on with your life! However, also being a computer genius, I did leave you a private message system should you ever need to yell at me or want to tell me to leave you alone! You already know that is not happening. But I would encourage you to go to the message system (link below) and take a look at a special photo album I put together. It's been 37 years since we last saw each other, so I think you can handle a short trip down memory lane along with a couple of funny pics.</p>
                    
                    <p>I leave for my 3-year circumnavigation on my boat <span class="gentle-emphasis">"It-Girl"</span> (yes, named after you) starting January 2026. I highly doubt we will ever see each other before my death (hopefully not too soon), and I was able to confirm through Greg and Jeff's recent birthday wish that your cell phone number is still active (I would bet you figured out I was behind that). I stopped sending you your annual birthday wish, figuring it was now your turn to send one to me. I think we both know you're not wired that way (now you better be laughing), but I was worried you had me on call blocking and didn't get my annual birthday wish...</p>
                    
                    <p><span class="emotional-text">So, I will end this here by simply telling you that I think about you almost every day. You were the one for me, the absolute love of my life, and the almost three years we were together are, by far, the greatest three years of my life‚Äîand that will never change.</span> I am sure you will, in some form or another, continue to be a part of my writings should I continue to write, and I sincerely wish you a happy, healthy, and wonderful life. I just won't call you Granny!</p>
                </div>
                
                <div class="letter-signature">
                    <div>With all my heart,</div>
                    <div class="name">Dave/Derek</div>
                    <div class="code">12757982 üôÇ</div>
                </div>
            </div>
        </div>
        
        <div class="button-section fade-in-delay">
            <p class="button-intro">Press the "Butt-on" to enter the message area</p>
            <a href="#" class="butt-button" onclick="accessMessageArea()">Enter Message Area</a>
            <p class="button-joke">You better have laughed at my choice of button... :)</p>
            <a href="index.html" class="escape-button">Oh my God, get me the hell out of here!</a>
        </div>
    </main>
    
    <script>
        // ============================================================================
        // AUTHENTICATION CHECK - Must be at the top of the script!
        // ============================================================================

(function() {
    // Check if user has valid authentication token
    const hasAccess = sessionStorage.getItem('rebeccaAccess');
    const accessTime = sessionStorage.getItem('accessTime');
    
    // If no valid token, show the "busted" screen
    if (hasAccess !== 'authenticated') {
        // Prevent the rest of the page from loading
        document.addEventListener('DOMContentLoaded', function() {
            showBustedScreen();
        });
        
        // Show the busted screen immediately
        if (document.body) {
            showBustedScreen();
        }
    }
    
    function showBustedScreen() {
        // Create overlay that covers everything
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 50%, #16213e 100%);
            z-index: 999999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            font-family: 'Georgia', serif;
        `;
        
        // Create the content
        overlay.innerHTML = `
            <div style="max-width: 600px; background: rgba(255, 255, 255, 0.1); 
                        border: 3px solid rgba(255, 69, 0, 0.8); border-radius: 20px; 
                        padding: 40px; backdrop-filter: blur(10px);
                        box-shadow: 0 0 50px rgba(255, 69, 0, 0.5);">
                
                <div style="font-size: 80px; margin-bottom: 20px;">üö´</div>
                
                <h1 style="color: #ff4500; font-size: 3rem; margin-bottom: 20px; 
                           text-shadow: 0 0 20px rgba(255, 69, 0, 0.8);">
                    NICE TRY!
                </h1>
                
                <p style="color: white; font-size: 1.5rem; line-height: 1.8; margin-bottom: 20px;">
                    Well, well, well... look who tried to bookmark a private page! üïµÔ∏è
                </p>
                
                <p style="color: #ffd700; font-size: 1.3rem; line-height: 1.6; margin-bottom: 25px;">
                    You have to actually <strong>answer the questions</strong> like everyone else, buddy.<br>
                    No shortcuts here!
                </p>
                
                <p style="color: rgba(255, 255, 255, 0.8); font-size: 1.1rem; margin-bottom: 15px;">
                    (Yes, Luke/Greg, we're looking at you üòè)
                </p>
                
                <div style="margin-top: 30px; padding: 20px; background: rgba(255, 0, 0, 0.2); 
                            border-radius: 10px; border: 2px solid rgba(255, 69, 0, 0.6);">
                    <p style="color: white; font-size: 1.2rem; margin-bottom: 10px;">
                        Redirecting you back to the homepage in:
                    </p>
                    <div id="countdown" style="font-size: 4rem; color: #ff4500; 
                                               font-weight: bold; text-shadow: 0 0 30px rgba(255, 69, 0, 1);">
                        20
                    </div>
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin-top: 10px;">
                        Enjoy the view while it lasts! üòÇ
                    </p>
                </div>
            </div>
        `;
        
        // Clear the body and add overlay
        document.body.innerHTML = '';
        document.body.appendChild(overlay);
        
        // Countdown timer
        let timeLeft = 20;
        const countdownElement = document.getElementById('countdown');
        
        const countdownInterval = setInterval(() => {
            timeLeft--;
            countdownElement.textContent = timeLeft;
            
            // Add some fun effects as time runs down
            if (timeLeft <= 5) {
                countdownElement.style.color = '#ff0000';
                countdownElement.style.transform = 'scale(1.2)';
                countdownElement.style.transition = 'all 0.3s';
            }
            
            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                window.location.href = 'index.html';
            }
        }, 1000);
    }
})();

// ============================================================================
// Rest of your page's normal JavaScript goes below this line
// ============================================================================
        // Background music functionality
        let musicStarted = false;
        let backgroundMusic = null;
        
        // Google Apps Script URL for notifications
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwM428b1zI_i0O5NVcIYDCcSXP2i2l-UjAoyx689k0W5LjSSW0JOaCPLZSKAwTg6iv8XA/exec';
        
        function initializeBackgroundMusic() {
            backgroundMusic = new Audio('./audio/nancy-background-music.mp3');
            backgroundMusic.loop = true;
            backgroundMusic.volume = 0.35; // 35% volume
            backgroundMusic.preload = 'auto';
        }
        
        function sendPageAccessNotification() {
            // Check if we've already sent a notification for this session
            const notificationSent = sessionStorage.getItem('nancy-page-notification-sent');
            if (notificationSent) {
                return; // Already sent this session
            }
            
            try {
                const notificationData = {
                    type: 'page_access',
                    page: 'rebecca-private-message.html',
                    message: 'Someone accessed Nancy\'s private message page',
                    sender: 'Page Access Monitor',
                    timestamp: new Date().toLocaleString(),
                    userAgent: navigator.userAgent.substring(0, 100), // Browser info (limited)
                    referrer: document.referrer || 'Direct access'
                };
                
                // Send notification using the same method as messages
                const form = document.createElement('form');
                form.action = APPS_SCRIPT_URL;
                form.method = 'POST';
                form.target = 'notificationFrame';
                form.style.display = 'none';
                
                const dataField = document.createElement('input');
                dataField.type = 'hidden';
                dataField.name = 'data';
                dataField.value = JSON.stringify(notificationData);
                form.appendChild(dataField);
                
                // Create hidden iframe for the notification
                let iframe = document.getElementById('notificationFrame');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.id = 'notificationFrame';
                    iframe.name = 'notificationFrame';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }
                
                document.body.appendChild(form);
                form.submit();
                
                // Clean up the form
                setTimeout(() => {
                    if (form.parentNode) {
                        document.body.removeChild(form);
                    }
                }, 1000);
                
                // Mark notification as sent for this session
                sessionStorage.setItem('nancy-page-notification-sent', 'true');
                console.log('Page access notification sent');
                
            } catch (error) {
                console.log('Failed to send page access notification:', error);
            }
        }
        
        function startBackgroundMusic() {
            if (musicStarted || !backgroundMusic) return;
            
            backgroundMusic.play().then(() => {
                musicStarted = true;
                showMusicIndicator();
                console.log('Background music started for Nancy');
            }).catch(error => {
                console.log('Music failed to start:', error);
            });
        }
        
        function startMusicFromPrompt() {
            // Hide the prompt box with animation
            const promptContainer = document.getElementById('musicPromptContainer');
            promptContainer.classList.add('hidden');
            
            // Start the music
            startBackgroundMusic();
            
            // Remove the prompt from DOM after animation completes
            setTimeout(() => {
                if (promptContainer.parentNode) {
                    promptContainer.parentNode.removeChild(promptContainer);
                }
            }, 500);
        }
        
        function showMusicIndicator() {
            const indicator = document.getElementById('musicIndicator');
            indicator.classList.add('show');
            
            // Hide the indicator after 4 seconds
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 4000);
        }
        
        function createParticles() {
            const particleField = document.getElementById('particleField');
            
            for (let i = 0; i < 60; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                particleField.appendChild(particle);
            }
        }
        
        function createFloatingHeart() {
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            heart.innerHTML = '‚ô•';
            heart.style.left = Math.random() * 90 + '%';
            heart.style.animationDuration = (12 + Math.random() * 8) + 's';
            document.body.appendChild(heart);
            
            setTimeout(() => {
                if (heart.parentNode) {
                    heart.parentNode.removeChild(heart);
                }
            }, 20000);
        }
        
        function accessMessageArea() {
            window.location.href = 'rebecca-private-message-area.html';
        }
           
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all functionality
            initializeBackgroundMusic();
            createParticles();
            
            // Send page access notification
            sendPageAccessNotification();
            
            // Start floating hearts
            setInterval(() => {
                if (Math.random() < 0.6) {
                    createFloatingHeart();
                }
            }, 9000 + Math.random() * 6000);
        });
        
        // Clean up when leaving the page
        window.addEventListener('beforeunload', function() {
            if (backgroundMusic && !backgroundMusic.paused) {
                backgroundMusic.pause();
            }
        });
    </script>
</body>
</html>

        // Your existing Apps Script URL
       const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwM428b1zI_i0O5NVcIYDCcSXP2i2l-UjAoyx689k0W5LjSSW0JOaCPLZSKAwTg6iv8XA/exec';
                
        // Variables
        let messagesData = [];
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        let isOnline = navigator.onLine;
        let lastMessageCount = 0;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            createStarfield();
            setupEventListeners();
            updateConnectionStatus();
            loadMessageHistory();
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
            
            setInterval(updateConnectionStatus, 10000);
        }
        
        function createStarfield() {
            const starfield = document.getElementById('starfield');
            for (let i = 0; i < 80; i++) {
                const star = document.createElement('div');
                star.className = `star ${['small', 'medium', 'large'][Math.floor(Math.random() * 3)]}`;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 4 + 's';
                starfield.appendChild(star);
            }
        }
        
        function setupEventListeners() {
            document.getElementById('messageForm').addEventListener('submit', handleSubmit);
            document.getElementById('refreshButton').addEventListener('click', () => loadMessageHistory(true));
            document.getElementById('messageText').addEventListener('input', updateCharCounter);
            
            // Connection status
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
                showStatus('Connection restored!', 'success');
                loadMessageHistory(true);
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
                showStatus('Connection lost. Will retry when back online.', 'error');
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    handleSubmit(e);
                } else if (e.key === 'F5') {
                    e.preventDefault();
                    loadMessageHistory(true);
                }
            });
        }
        
        // Message loading - copied from working Nancy-Backdoor.html
        async function loadMessageHistory(showLoading = false) {
            try {
                if (showLoading) {
                    document.getElementById('loadingContainer').style.display = 'flex';
                    document.getElementById('messagesList').style.display = 'none';
                    document.getElementById('noMessages').style.display = 'none';
                }
                
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getMessages&t=${Date.now()}`);
                const result = await response.json();
                
                if (result.success) {
                    messagesData = result.messages || [];
                    displayMessages();
                    updateMessageStats();
                    updateConnectionStatus(true);
                    
                    // Show notification for new messages
                    if (messagesData.length > lastMessageCount && lastMessageCount > 0) {
                        const newCount = messagesData.length - lastMessageCount;
                        showStatus(`${newCount} new message${newCount > 1 ? 's' : ''}!`, 'info');
                        playNotificationSound();
                    }
                    lastMessageCount = messagesData.length;
                    
                } else {
                    console.error('Failed to load messages:', result.error);
                    showStatus('Failed to load message history: ' + (result.error || 'Unknown error'), 'error');
                    updateConnectionStatus(false);
                    displayFallbackMessage();
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                showStatus('Network error loading messages. Please check your connection.', 'error');
                updateConnectionStatus(false);
                
                // Show cached messages if available
                if (messagesData.length > 0) {
                    displayMessages();
                    showStatus('Showing cached messages. Connection will retry automatically.', 'info');
                } else {
                    displayFallbackMessage();
                }
            } finally {
                document.getElementById('loadingContainer').style.display = 'none';
            }
        }
        
        function displayMessages() {
            const messagesList = document.getElementById('messagesList');
            const noMessages = document.getElementById('noMessages');
            const container = document.getElementById('messagesContainer');
            
            if (messagesData.length === 0) {
                messagesList.style.display = 'none';
                noMessages.style.display = 'block';
                return;
            }
            
            noMessages.style.display = 'none';
            messagesList.style.display = 'flex';
            messagesList.innerHTML = '';
            
            messagesData.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${(message.sender || '').toLowerCase()}`;
                messageDiv.style.animationDelay = `${index * 0.1}s`;
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${escapeHtml(message.sender || 'Unknown')}</span>
                        <span class="message-time">${formatTimestamp(message.timestamp)}</span>
                    </div>
                    <div class="message-content">${escapeHtml(message.message || '')}</div>
                `;
                
                messagesList.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function displayFallbackMessage() {
            document.getElementById('messagesList').style.display = 'flex';
            document.getElementById('noMessages').style.display = 'none';
            document.getElementById('messagesList').innerHTML = `
                <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.7);">
                    <p>üìß Messages are being saved to your Google Sheet</p>
                    <p style="margin-top: 10px; font-size: 0.9rem;">Message display requires backend setup. Sending still works!</p>
                </div>
            `;
        }
        
        function updateMessageStats() {
            const messageCount = document.getElementById('messageCount');
            const lastUpdated = document.getElementById('lastUpdated');
            
            if (messagesData.length === 0) {
                messageCount.textContent = 'No messages';
            } else {
                const nancyMessages = messagesData.filter(m => (m.sender || '').toLowerCase() === 'nancy').length;
                const derekMessages = messagesData.filter(m => (m.sender || '').toLowerCase() === 'derek').length;
                messageCount.textContent = `${messagesData.length} total (Nancy: ${nancyMessages}, Derek: ${derekMessages})`;
            }
            
            lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }
        
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                // Audio not supported or blocked
            }
        }
        
      function formatTimestamp(timestamp) {
    try {
        if (!timestamp) return 'Unknown time';
        const date = new Date(timestamp);
        return date.toLocaleString();
    } catch (e) {
        return timestamp || 'Unknown time';
    }
      }

          function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
        
        // Message sending
        async function handleSubmit(event) {
            event.preventDefault();
            
            const messageText = document.getElementById('messageText');
            const messageContent = messageText.value.trim();
            
            if (!messageContent) {
                showStatus('Please enter a message', 'error');
                messageText.focus();
                return;
            }
            
            if (!isOnline) {
                showStatus('No internet connection. Please try again when online.', 'error');
                return;
            }
            
            setFormLoading(true);
            
            try {
                // Use your existing message sending method
                const success = await sendMessageViaForm(messageContent, 'Nancy');
                
                if (success) {
                    showStatus('Message sent! Derek will be notified.', 'success');
                    messageText.value = '';
                    updateCharCounter();
                    
                    // Refresh after a delay
                    setTimeout(() => loadMessageHistory(), 2000);
                } else {
                    throw new Error('Failed to send message');
                }
                
            } catch (error) {
                console.error('Send error:', error);
                showStatus('Error sending message. Please try again.', 'error');
            } finally {
                setFormLoading(false);
            }
        }
        
        // Your existing message sending method
        function sendMessageViaForm(message, sender = 'Nancy') {
            return new Promise((resolve) => {
                const data = {
                    message: message,
                    sender: sender,
                    timestamp: new Date().toLocaleString()
                };
                
                const form = document.createElement('form');
                form.action = APPS_SCRIPT_URL;
                form.method = 'POST';
                form.target = 'hiddenFrame';
                form.style.display = 'none';
                
                const dataField = document.createElement('input');
                dataField.type = 'hidden';
                dataField.name = 'data';
                dataField.value = JSON.stringify(data);
                form.appendChild(dataField);
                
                let iframe = document.getElementById('hiddenFrame');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.id = 'hiddenFrame';
                    iframe.name = 'hiddenFrame';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }
                
                document.body.appendChild(form);
                form.submit();
                
                setTimeout(() => {
                    if (form.parentNode) {
                        document.body.removeChild(form);
                    }
                    resolve(true);
                }, 1000);
            });
        }
        
        function setFormLoading(loading) {
            const submitButton = document.getElementById('submitButton');
            const messageText = document.getElementById('messageText');
            const refreshButton = document.getElementById('refreshButton');
            
            if (loading) {
                submitButton.disabled = true;
                submitButton.classList.add('loading');
                messageText.disabled = true;
                refreshButton.disabled = true;
            } else {
                submitButton.disabled = false;
                submitButton.classList.remove('loading');
                messageText.disabled = false;
                refreshButton.disabled = false;
                messageText.focus();
            }
        }
        
        function updateCharCounter() {
            const messageText = document.getElementById('messageText');
            const charCounter = document.getElementById('charCounter');
            const length = messageText.value.length;
            const maxLength = 1000;
            
            charCounter.textContent = `${length} / ${maxLength}`;
            
            if (length > maxLength * 0.9) {
                charCounter.className = 'char-counter danger';
            } else if (length > maxLength * 0.7) {
                charCounter.className = 'char-counter warning';
            } else {
                charCounter.className = 'char-counter';
            }
        }
        
        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                toggle.classList.add('active');
                startAutoRefresh();
                showStatus('Auto-refresh enabled (every 30 seconds)', 'success');
            } else {
                toggle.classList.remove('active');
                stopAutoRefresh();
                showStatus('Auto-refresh disabled', 'info');
            }
        }
        
        function startAutoRefresh() {
            stopAutoRefresh();
            if (autoRefreshEnabled) {
                autoRefreshInterval = setInterval(() => {
                    if (isOnline && autoRefreshEnabled) {
                        loadMessageHistory();
                    }
                }, 30000);
            }
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        function updateConnectionStatus(forceOnline = null) {
            const statusIndicator = document.getElementById('statusIndicator');
            const headerIndicator = document.getElementById('headerStatusIndicator');
            const statusText = document.getElementById('statusText');
            const connectionStatus = document.getElementById('connectionStatus');
            
            const online = forceOnline !== null ? forceOnline : isOnline;
            
            if (online) {
                statusIndicator.classList.add('connected');
                headerIndicator.classList.add('connected');
                statusText.textContent = 'Connected';
                connectionStatus.classList.remove('offline');
                connectionStatus.classList.add('online');
            } else {
                statusIndicator.classList.remove('connected');
                headerIndicator.classList.remove('connected');
                statusText.textContent = 'Offline';
                connectionStatus.classList.remove('online');
                connectionStatus.classList.add('offline');
            }
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 4000);
        }
        
        // Initialize
        window.addEventListener('load', () => {
            updateCharCounter();
            updateMessageStats();
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
